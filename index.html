<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Scanner Tickets Mobile</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 10px;
    background: #f5f5f5;
  }
  .container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  h1 { font-size: 1.5rem; margin: 0 0 15px 0; color: #333; }
  .camera-container { position: relative; width: 100%; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
  video { width: 100%; height: auto; display: block; }
  canvas { display: none; }
  .camera-overlay { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10; }
  .btn { 
    padding: 12px 24px; 
    font-size: 16px; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: all 0.3s;
  }
  .btn:active { transform: scale(0.95); }
  .btn-primary { background: #007bff; color: white; }
  .btn-success { background: #28a745; color: white; }
  .btn-danger { background: #dc3545; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-large { width: 70px; height: 70px; border-radius: 50%; font-size: 24px; }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
  .status { padding: 10px; background: #e3f2fd; border-radius: 5px; margin: 10px 0; text-align: center; font-weight: 500; }
  .status.success { background: #d4edda; color: #155724; }
  .status.error { background: #f8d7da; color: #721c24; }
  .status.loading { background: #fff3cd; color: #856404; }
  .debug { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
  table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
  th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
  th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
  .total-row { background: #d4edda; font-weight: 700; font-size: 16px; }
  .month-header { background: #007bff; color: white; font-weight: 700; font-size: 15px; text-align: center; cursor: pointer; user-select: none; }
  .month-header:hover { background: #0056b3; }
  .month-total { background: #e7f3ff; font-weight: 600; font-style: italic; }
  input[type="number"], input[type="text"], input[type="date"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
  .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
  progress { width: 100%; height: 30px; margin: 10px 0; }
  .hidden { display: none !important; }
  .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .manual-card {
    border: 1px solid #e6e6e6; border-radius: 10px; padding: 12px; background: #fcfcfc; margin-top: 10px;
  }
  .manual-grid { display: grid; grid-template-columns: 0.8fr 1fr 1fr 0.8fr 0.8fr 0.8fr auto; gap: 8px; align-items: end; }
  .manual-grid label { font-size: 12px; color: #555; display:block; margin-bottom: 4px;}
  .muted { color:#666; font-size:12px; }
  .collapsed { display: none; }
  @media (max-width: 600px) {
    body { padding: 5px; }
    .container { padding: 10px; }
    h1 { font-size: 1.2rem; }
    .btn { padding: 10px 16px; font-size: 14px; }
    th, td { padding: 6px; font-size: 12px; }
    .manual-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üì± Scanner de Tickets Mobile</h1>
    
    <div class="camera-container" id="cameraContainer" style="display:none">
      <video id="video" autoplay playsinline></video>
      <div class="camera-overlay">
        <button id="captureBtn" class="btn btn-primary btn-large">üì∏</button>
      </div>
    </div>

    <canvas id="canvas"></canvas>

    <div class="controls">
      <button id="startCamera" class="btn btn-primary">üì∑ Ouvrir Cam√©ra</button>
      <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">
      <button id="uploadBtn" class="btn btn-success">üñº Choisir Photo</button>
      <button id="doOcr" class="btn btn-success" disabled>üîç Scanner</button>
      <button id="exportPdf" class="btn btn-secondary">üìÑ Export PDF</button>
      <button id="clearHistory" class="btn btn-danger">üóëÔ∏è Effacer</button>
      <!-- === Google Drive === -->
      <span style="flex:1"></span>
      <button id="gConnect" class="btn btn-primary">üîê Se connecter Drive</button>
      <button id="gSave" class="btn btn-secondary" disabled>üíæ Sauver sur Drive</button>
      <button id="gLoad" class="btn btn-secondary" disabled>‚òÅÔ∏è Charger de Drive</button>
    </div>

    <!-- FILTRES -->
    <div class="manual-card" style="margin-bottom: 10px;">
      <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 150px;">
          <label for="filterMonth" style="font-size: 12px; color: #555; display:block; margin-bottom: 4px;">Filtrer par mois</label>
          <select id="filterMonth" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="all">Tous les mois</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
          <label for="filterCategory" style="font-size: 12px; color: #555; display:block; margin-bottom: 4px;">Filtrer par cat√©gorie</label>
          <select id="filterCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="all">Toutes les cat√©gories</option>
          </select>
        </div>
      </div>
    </div>

    <!-- AJOUT MANUEL -->
    <div class="manual-card">
      <div class="manual-grid">
        <div>
          <label for="mDate">Date</label>
          <input type="date" id="mDate">
        </div>
        <div>
          <label for="mCategory">Cat√©gorie</label>
          <select id="mCategory">
            <option value="Restaurant">üç¥ Restaurant</option>
            <option value="Fournisseur">üì¶ Fournisseur</option>
              <option value="Magazin">üì¶ Magazin</option>
            <option value="Gazole">üöó Gazole</option>
            <option value="Transport">üöó Transport</option>
            <option value="√âquipement">üîß √âquipement</option>
            <option value="Services">üíº Services</option>
            <option value="Divers">üìã Divers</option>
          </select>
        </div>
        <div>
          <label for="mSupplier">Fournisseur</label>
          <input type="text" id="mSupplier" placeholder="Nom du fournisseur">
        </div>
        <div>
          <label for="mHT">HT (‚Ç¨)</label>
          <input type="number" id="mHT" step="0.01" min="0" placeholder="0,00">
        </div>
        <div>
          <label for="mTVARate">Taux TVA</label>
          <select id="mTVARate">
            <option value="20" selected>20 %</option>
            <option value="10">10 %</option>
            <option value="5.5">5,5 %</option>
            <option value="2.1">2,1 %</option>
            <option value="0">0 %</option>
          </select>
        </div>
        <div>
          <label for="mTTC">TTC (auto)</label>
          <input type="text" id="mTTC" disabled>
          <div class="muted" id="mTVAVal">TVA: 0,00 ‚Ç¨</div>
        </div>
        <div>
          <button id="addManual" class="btn btn-success">‚ûï Ajouter</button>
        </div>
      </div>
    </div>

    <div id="status" class="status hidden"></div>
    <progress id="progress" value="0" max="1" class="hidden"></progress>
    <div id="debug" class="debug hidden"></div>

    <h2>üìä Historique (<span id="count">0</span> tickets)</h2>
    <div class="table-wrapper">
      <table id="historyTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Cat√©gorie</th>
            <th>Fournisseur</th>
            <th>HT (‚Ç¨)</th>
            <th>Taux TVA</th>
            <th>TVA (‚Ç¨)</th>
            <th>TTC (‚Ç¨)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" style="text-align:center;color:#999">Aucun ticket</td></tr>
        </tbody>
        <tfoot id="tfoot" class="hidden">
          <tr class="total-row">
            <td colspan="3">TOTAUX G√âN√âRAUX</td>
            <td id="sumHT">0.00</td>
            <td id="sumRate">‚Äî</td>
            <td id="sumTVA">0.00</td>
            <td id="sumTTC">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- Google Identity Services + (optional) gapi for discovery -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  
  <script>
  // ---------- S√©lecteurs ----------
  const startCameraBtn = document.getElementById('startCamera');
  const captureBtn = document.getElementById('captureBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const doOcrBtn = document.getElementById('doOcr');
  const exportPdfBtn = document.getElementById('exportPdf');
  const clearHistoryBtn = document.getElementById('clearHistory');
  const cameraContainer = document.getElementById('cameraContainer');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');
  const progressEl = document.getElementById('progress');
  const debugEl = document.getElementById('debug');
  const tbody = document.getElementById('tbody');
  const tfoot = document.getElementById('tfoot');
  const countEl = document.getElementById('count');

  // Ajout manuel
  const mDate = document.getElementById('mDate');
  const mCategory = document.getElementById('mCategory');
  const mSupplier = document.getElementById('mSupplier');
  const mHT = document.getElementById('mHT');
  const mTVARate = document.getElementById('mTVARate');
  const mTTC = document.getElementById('mTTC');
  const mTVAVal = document.getElementById('mTVAVal');
  const addManualBtn = document.getElementById('addManual');

  // Filtres
  const filterMonth = document.getElementById('filterMonth');
  const filterCategory = document.getElementById('filterCategory');

  // Google Drive
  const gConnect = document.getElementById('gConnect');
  const gSave = document.getElementById('gSave');
  const gLoad = document.getElementById('gLoad');

  // ---------- √âtat ----------
  let stream = null;
  let currentImage = null;
  let tickets = [];
  let collapsedMonths = new Set(); // Pour g√©rer les mois repli√©s
  let currentMonthFilter = 'all';
  let currentCategoryFilter = 'all';

  // Google OAuth2 state
  const GOOGLE_CLIENT_ID = "1091571219099-ev8cbh3d7vbkgr6p5gah5us88m57ibsm.apps.googleusercontent.com"; // fournie par vous
  const DRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.appdata';
  let tokenClient = null; // GIS token client
  let accessToken = null;
  let appDataFileId = null; // id du fichier tickets.json dans appDataFolder

  // ---------- Stockage (avec fallback m√©moire) ----------
  function storageAvailable() {
    try {
      const x = '__tck__';
      localStorage.setItem(x, '1');
      localStorage.removeItem(x);
      return true;
    } catch (e) { return false; }
  }
  const HAS_STORAGE = storageAvailable();
  const memStore = { value: '[]' };

  function saveTicketsLocal() {
    const data = JSON.stringify(tickets);
    try {
      if (HAS_STORAGE) localStorage.setItem('tickets', data);
      else memStore.value = data;
    } catch(_) { /* ignore */ }
  }
  function loadTicketsLocal() {
    try {
      const saved = HAS_STORAGE ? localStorage.getItem('tickets') : memStore.value;
      if (saved) {
        tickets = JSON.parse(saved).map(t => {
          if (typeof t.tvaRate === 'undefined') t.tvaRate = 20;
          if (typeof t.category === 'undefined') t.category = 'Divers';
          return t;
        });
      }
    } catch(_) { tickets = []; }
  }

  // ---------- Utilitaires ----------
  function to2(n){return (Math.round(n*100)/100).toFixed(2);} 
  function calcFromHT(ht, rate){
    const r = parseFloat(rate)||0;
    const tva = ht * (r/100);
    const ttc = ht + tva;
    return {tva: to2(tva), ttc: to2(ttc)};
  }
  function frToDateObj(fr) {
    // accepte "dd/mm/yyyy" ou "dd-mm-yyyy"
    const m = fr.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
    if (m) return new Date(+m[3], +m[2]-1, +m[1]);
    // ISO ou autre
    return new Date(fr);
  }
  function getMonthKey(dateStr) {
    const d = frToDateObj(dateStr);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
  }
  function getMonthLabel(monthKey) {
    const [year, month] = monthKey.split('-');
    const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    return `${months[parseInt(month) - 1]} ${year}`;
  }
  function sortTickets() {
    // TRI CROISSANT : du plus ancien au plus r√©cent
    tickets.sort((a,b) => frToDateObj(a.date) - frToDateObj(b.date));
  }
  function showStatus(msg, type) {
    statusEl.textContent = msg;
    statusEl.className = 'status ' + type;
    statusEl.classList.remove('hidden');
    clearTimeout(showStatus._t);
    showStatus._t = setTimeout(() => statusEl.classList.add('hidden'), 4000);
  }

  // ---------- Ajout manuel (aper√ßu TTC) ----------
  function updateManualPreview(){
    const ht = parseFloat((mHT.value||'').toString().replace(',','.'))||0;
    const rate = parseFloat(mTVARate.value)||0;
    const {tva, ttc} = calcFromHT(ht, rate);
    mTTC.value = (ttc.replace('.', ',')) + ' ‚Ç¨';
    mTVAVal.textContent = 'TVA: ' + tva.replace('.', ',') + ' ‚Ç¨';
  }
  mDate.valueAsDate = new Date();
  mHT.addEventListener('input', updateManualPreview);
  mTVARate.addEventListener('change', updateManualPreview);
  updateManualPreview();

  addManualBtn.addEventListener('click', () => {
    const date = mDate.value ? new Date(mDate.value).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR');
    const category = mCategory.value;
    const supplier = (mSupplier.value||'Inconnu').trim();
    const ht = parseFloat((mHT.value||'0').toString().replace(',','.'));
    const rate = parseFloat(mTVARate.value)||0;

    if (!ht || ht<=0){ showStatus('‚ö†Ô∏è Saisissez un montant HT valide.', 'error'); return; }

    const {tva, ttc} = calcFromHT(ht, rate);
    const ticket = {
      id: Date.now(),
      date,
      category,
      supplier: supplier || 'Inconnu',
      ht: to2(ht),
      tva: tva,
      ttc: ttc,
      tvaRate: rate
    };
    tickets.push(ticket);
    sortTickets();
    saveTicketsLocal();
    updateFilters();
    renderTickets();
    showStatus('‚úÖ Ticket ajout√© manuellement !', 'success');

    // reset l√©ger
    mSupplier.value = '';
    mHT.value = '';
    updateManualPreview();
  });

  // ---------- Cam√©ra & OCR ----------
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      video.srcObject = stream;
      cameraContainer.style.display = 'block';
      startCameraBtn.textContent = 'üî¥ Fermer Cam√©ra';
      startCameraBtn.onclick = stopCamera;
      showStatus('‚úÖ Cam√©ra activ√©e - Positionnez le ticket', 'success');
    } catch (e) { showStatus('‚ùå Erreur cam√©ra: ' + e.message, 'error'); }
  }
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.srcObject = null;
    }
    cameraContainer.style.display = 'none';
    startCameraBtn.textContent = 'üì∑ Ouvrir Cam√©ra';
    startCameraBtn.onclick = startCamera;
  }
  startCameraBtn.onclick = startCamera;

  const ctx2d = ctx;
  function preprocessCanvas() {
    const w = canvas.width, h = canvas.height;
    const imgData = ctx2d.getImageData(0, 0, w, h);
    const data = imgData.data;
    for (let i = 0; i < data.length; i += 4) {
      const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
      const enhanced = ((gray - 128) * 1.4) + 128;
      const clamped = Math.max(0, Math.min(255, enhanced));
      data[i] = data[i + 1] = data[i + 2] = clamped;
    }
    ctx2d.putImageData(imgData, 0, 0);
  }

  captureBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx2d.drawImage(video, 0, 0);
    preprocessCanvas();
    currentImage = canvas.toDataURL('image/jpeg', 0.92);
    doOcrBtn.disabled = false;
    stopCamera();
    showStatus('‚úÖ Photo captur√©e - Cliquez sur Scanner', 'success');
  });

  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const maxW = 2000;
        const scale = Math.min(1, maxW / img.width);
        canvas.width = Math.floor(img.width * scale);
        canvas.height = Math.floor(img.height * scale);
        ctx2d.drawImage(img, 0, 0, canvas.width, canvas.height);
        preprocessCanvas();
        currentImage = canvas.toDataURL('image/jpeg', 0.92);
        doOcrBtn.disabled = false;
        showStatus('‚úÖ Image charg√©e - Cliquez sur Scanner', 'success');
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  doOcrBtn.addEventListener('click', async () => {
    if (!currentImage) return;
    doOcrBtn.disabled = true;
    showStatus('üîç Analyse en cours...', 'loading');
    progressEl.classList.remove('hidden');
    progressEl.value = 0;
    debugEl.classList.add('hidden');

    try {
      const worker = Tesseract.createWorker({
        logger: m => {
          if (m.status === 'recognizing text' && m.progress) progressEl.value = m.progress;
        }
      });
      await worker.load();
      await worker.loadLanguage('fra');
      await worker.initialize('fra');
      const { data: { text } } = await worker.recognize(currentImage);
      await worker.terminate();

      const parsed = parseTicket(text);

      debugEl.innerHTML = `<strong>Texte OCR:</strong><br>${text.replace(/\n/g, '<br>')}<br><br><strong>D√©tect√©:</strong><br>Fournisseur: ${parsed.supplier}<br>Date: ${parsed.date}<br>HT: ${parsed.htAmount || 'NON TROUV√â'}`;
      debugEl.classList.remove('hidden');

      if (parsed.htAmount) {
        addTicketFromOCR(parsed);
        showStatus('‚úÖ Ticket ajout√© !', 'success');
      } else {
        showStatus('‚ö†Ô∏è Prix HT non d√©tect√© - V√©rifiez le debug ci-dessous', 'error');
      }
    } catch (err) {
      showStatus('‚ùå Erreur: ' + err.message, 'error');
    } finally {
      progressEl.classList.add('hidden');
      doOcrBtn.disabled = false;
    }
  });

  function parseTicket(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
    let supplier = 'Non d√©tect√©';
    let date = new Date().toLocaleDateString('fr-FR');
    let htAmount = null;

    const supplierPatterns = [
      /VINCI|INTERMARCH[E√â]|CARREFOUR|AUCHAN|LECLERC|E\.?LECLERC|CASINO|LIDL|FRANPRIX|MONOPRIX|BRICO\s*D[E√â]POT|BRICOLAGE|COM√òLA|COM@LA/i
    ];
    for (const line of lines.slice(0, 15)) {
      for (const pattern of supplierPatterns) {
        if (pattern.test(line)) {
          supplier = line.slice(0, 40).replace(/[^a-zA-Z0-9\s@√ò√â√à√ä√Ç√Ñ√ã√è√ì√õ√ô√á-]/g, ' ').trim();
          break;
        }
      }
      if (supplier !== 'Non d√©tect√©') break;
    }
    if (supplier === 'Non d√©tect√©') supplier = lines[0]?.slice(0, 30) || 'Inconnu';

    for (const l of lines) {
      const datePatterns = [
        /(\d{2}[\/\-]\d{2}[\/\-]\d{4})/,
        /(\d{2}[\/\-]\d{2}[\/\-]\d{2})/,
        /Date[:\s]+(\d{2}[\/\-]\d{2}[\/\-]\d{4})/i
      ];
      for (const pattern of datePatterns) {
        const m = l.match(pattern);
        if (m) { 
          const raw = m[1];
          if (/^\d{2}[\/\-]\d{2}[\/\-]\d{2}$/.test(raw)) {
            const [d, mth, yy] = raw.split(/[\/\-]/);
            date = `${d}/${mth}/20${yy}`;
          } else {
            date = raw.replace(/-/g,'/');
          }
          break; 
        }
      }
    }

    for (const l of lines) {
      if (/\b(h\.?t\.?|hors[\s-]?taxe|prix[\s]+h\.?t\.?)\b/i.test(l)) {
        const nums = l.match(/([0-9]+[.,][0-9]{2})/g);
        if (nums) { htAmount = nums[nums.length - 1].replace(',', '.'); break; }
      }
    }
    if (!htAmount) {
      for (const l of lines) {
        if (/total[\s]*ttc|tot[\s]*ttc/i.test(l)) {
          const nums = l.match(/([0-9]+[.,][0-9]{2})/g);
          if (nums) { const ttc = parseFloat(nums[nums.length - 1].replace(',', '.')); htAmount = (ttc / 1.20).toFixed(2); break; }
        }
      }
    }
    return { supplier, date, htAmount };
  }

  function addTicketFromOCR(data) {
    const ht = parseFloat(data.htAmount);
    if (isNaN(ht) || ht <= 0) return;
    const rate = typeof data.tvaRate !== 'undefined' ? parseFloat(data.tvaRate) : 20;
    const {tva, ttc} = calcFromHT(ht, rate);
    const ticket = {
      id: Date.now(),
      date: data.date,
      category: 'Divers',
      supplier: data.supplier,
      ht: to2(ht),
      tva: tva,
      ttc: ttc,
      tvaRate: rate
    };
    tickets.push(ticket);
    sortTickets();
    saveTicketsLocal();
    updateFilters();
    renderTickets();
  }

  // ---------- Toggle mois ----------
  window.toggleMonth = function(monthKey) {
    if (collapsedMonths.has(monthKey)) {
      collapsedMonths.delete(monthKey);
    } else {
      collapsedMonths.add(monthKey);
    }
    renderTickets();
  };

  // ---------- Filtres ----------
  function updateFilters() {
    // Mise √† jour du filtre de mois
    const months = new Set();
    tickets.forEach(t => months.add(getMonthKey(t.date)));
    const sortedMonths = Array.from(months).sort();
    
    filterMonth.innerHTML = '<option value="all">Tous les mois</option>';
    sortedMonths.forEach(mk => {
      const opt = document.createElement('option');
      opt.value = mk;
      opt.textContent = getMonthLabel(mk);
      filterMonth.appendChild(opt);
    });
    filterMonth.value = currentMonthFilter;

    // Mise √† jour du filtre de cat√©gorie
    const categories = new Set();
    tickets.forEach(t => categories.add(t.category || 'Divers'));
    const sortedCategories = Array.from(categories).sort();
    
    filterCategory.innerHTML = '<option value="all">Toutes les cat√©gories</option>';
    sortedCategories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      filterCategory.appendChild(opt);
    });
    filterCategory.value = currentCategoryFilter;
  }

  filterMonth.addEventListener('change', (e) => {
    currentMonthFilter = e.target.value;
    renderTickets();
  });

  filterCategory.addEventListener('change', (e) => {
    currentCategoryFilter = e.target.value;
    renderTickets();
  });

  // ---------- Rendu & Edition (avec groupement par mois) ----------
  function renderTickets() {
    tbody.innerHTML = '';
    
    // Appliquer les filtres
    let filteredTickets = tickets;
    
    if (currentMonthFilter !== 'all') {
      filteredTickets = filteredTickets.filter(t => getMonthKey(t.date) === currentMonthFilter);
    }
    
    if (currentCategoryFilter !== 'all') {
      filteredTickets = filteredTickets.filter(t => (t.category || 'Divers') === currentCategoryFilter);
    }

    countEl.textContent = filteredTickets.length;

    if (filteredTickets.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999">Aucun ticket</td></tr>';
      tfoot.classList.add('hidden');
      return;
    }

    let totalHT = 0, totalTVA = 0, totalTTC = 0;

    // Grouper par mois
    const byMonth = {};
    filteredTickets.forEach(t => {
      const key = getMonthKey(t.date);
      if (!byMonth[key]) byMonth[key] = [];
      byMonth[key].push(t);
    });

    // Trier les cl√©s de mois (ordre croissant)
    const monthKeys = Object.keys(byMonth).sort();

    monthKeys.forEach(monthKey => {
      const monthTickets = byMonth[monthKey];
      let monthHT = 0, monthTVA = 0, monthTTC = 0;

      // En-t√™te du mois (cliquable pour replier/d√©plier)
      const headerRow = document.createElement('tr');
      headerRow.className = 'month-header';
      headerRow.onclick = () => toggleMonth(monthKey);
      const icon = collapsedMonths.has(monthKey) ? '‚ñ∂' : '‚ñº';
      headerRow.innerHTML = `<td colspan="8">${icon} ${getMonthLabel(monthKey)} (${monthTickets.length} tickets)</td>`;
      tbody.appendChild(headerRow);

      const isCollapsed = collapsedMonths.has(monthKey);

      // Lignes des tickets du mois
      monthTickets.forEach(t => {
        totalHT += parseFloat(t.ht);
        totalTVA += parseFloat(t.tva);
        totalTTC += parseFloat(t.ttc);
        monthHT += parseFloat(t.ht);
        monthTVA += parseFloat(t.tva);
        monthTTC += parseFloat(t.ttc);

        const tr = document.createElement('tr');
        if (isCollapsed) tr.className = 'collapsed';
        tr.innerHTML = `
          <td><input type="text" value="${t.date}" onchange="updateField(${t.id},'date',this.value,true)" style="width:100px"></td>
          <td>
            <select onchange="updateField(${t.id},'category',this.value)" style="width:100%">
              <option value="Restaurant" ${t.category==='Restaurant'?'selected':''}>üç¥ Restaurant</option>
              <option value="Fournisseur" ${t.category==='Fournisseur'?'selected':''}>üì¶ Fournisseur</option>
              <option value="Magazin" ${t.category==='Magazin'?'selected':''}>üì¶ Magazin</option>
              <option value="Gazole" ${t.category==='Gazole'?'selected':''}>üöó Gazole</option>
              <option value="Transport" ${t.category==='Transport'?'selected':''}>üöó Transport</option>
              
              <option value="√âquipement" ${t.category==='√âquipement'?'selected':''}>üîß √âquipement</option>
              <option value="Services" ${t.category==='Services'?'selected':''}>üíº Services</option>
              <option value="Divers" ${(t.category==='Divers'||!t.category)?'selected':''}>üìã Divers</option>
            </select>
          </td>
          <td><input type="text" value="${t.supplier}" onchange="updateField(${t.id},'supplier',this.value)"></td>
          <td><input type="number" step="0.01" value="${t.ht}" onchange="updateHT(${t.id},this.value)" style="width:80px"></td>
          <td>
            <select onchange="updateRate(${t.id}, this.value)" style="width:90px">
              <option value="20" ${( +t.tvaRate===20)?'selected':''}>20 %</option>
              <option value="10" ${( +t.tvaRate===10)?'selected':''}>10 %</option>
              <option value="5.5" ${( +t.tvaRate===5.5)?'selected':''}>5,5 %</option>
              <option value="2.1" ${( +t.tvaRate===2.1)?'selected':''}>2,1 %</option>
              <option value="0" ${( +t.tvaRate===0)?'selected':''}>0 %</option>
            </select>
          </td>
          <td>${t.tva}</td>
          <td>${t.ttc}</td>
          <td><button class="delete-btn" onclick="deleteTicket(${t.id})">üóëÔ∏è</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Sous-total du mois
      const totalRow = document.createElement('tr');
      totalRow.className = 'month-total';
      if (isCollapsed) totalRow.className += ' collapsed';
      totalRow.innerHTML = `
        <td colspan="3">üìä Total ${getMonthLabel(monthKey)}</td>
        <td>${monthHT.toFixed(2)}</td>
        <td>‚Äî</td>
        <td>${monthTVA.toFixed(2)}</td>
        <td>${monthTTC.toFixed(2)}</td>
        <td></td>
      `;
      tbody.appendChild(totalRow);
    });

    document.getElementById('sumHT').textContent = totalHT.toFixed(2);
    document.getElementById('sumTVA').textContent = totalTVA.toFixed(2);
    document.getElementById('sumTTC').textContent = totalTTC.toFixed(2);
    document.getElementById('sumRate').textContent = '‚Äî';
    tfoot.classList.remove('hidden');
  }

  window.updateHT = function(id, val) {
    const ticket = tickets.find(t => t.id === id);
    if (!ticket) return;
    const ht = parseFloat(val) || 0;
    const rate = parseFloat(ticket.tvaRate)||0;
    const {tva, ttc} = calcFromHT(ht, rate);
    ticket.ht = to2(ht);
    ticket.tva = tva;
    ticket.ttc = ttc;
    saveTicketsLocal();
    renderTickets();
  };

  window.updateRate = function(id, rateVal){
    const ticket = tickets.find(t => t.id === id);
    if (!ticket) return;
    const rate = parseFloat(rateVal)||0;
    ticket.tvaRate = rate;
    const ht = parseFloat(ticket.ht)||0;
    const {tva, ttc} = calcFromHT(ht, rate);
    ticket.tva = tva;
    ticket.ttc = ttc;
    saveTicketsLocal();
    renderTickets();
  };

  window.updateField = function(id, field, val, resort=false) {
    const ticket = tickets.find(t => t.id === id);
    if (!ticket) return;
    ticket[field] = val;
    if (field === 'date' || resort) sortTickets();
    if (field === 'category') updateFilters();
    saveTicketsLocal();
    renderTickets();
  };

  window.deleteTicket = function(id) {
    if (confirm('Supprimer ce ticket ?')) {
      tickets = tickets.filter(t => t.id !== id);
      saveTicketsLocal();
      updateFilters();
      renderTickets();
    }
  };

  clearHistoryBtn.addEventListener('click', () => {
    if (confirm('Effacer TOUS les tickets ?')) {
      tickets = [];
      saveTicketsLocal();
      renderTickets();
      showStatus('‚úÖ Historique effac√©', 'success');
    }
  });

  // ---------- Export PDF ----------
  exportPdfBtn.addEventListener('click', () => {
    // Utiliser les tickets filtr√©s selon les filtres actifs
    let ticketsToExport = tickets;
    
    if (currentMonthFilter !== 'all') {
      ticketsToExport = ticketsToExport.filter(t => getMonthKey(t.date) === currentMonthFilter);
    }
    
    if (currentCategoryFilter !== 'all') {
      ticketsToExport = ticketsToExport.filter(t => (t.category || 'Divers') === currentCategoryFilter);
    }

    if (ticketsToExport.length === 0) {
      alert('Aucun ticket √† exporter pour cette s√©lection');
      return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text('Historique des Tickets', 14, 20);
    doc.setFontSize(10);
    let subtitle = `G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`;
    if (currentMonthFilter !== 'all') subtitle += ` - ${getMonthLabel(currentMonthFilter)}`;
    if (currentCategoryFilter !== 'all') subtitle += ` - ${currentCategoryFilter}`;
    doc.text(subtitle, 14, 28);

    const tableData = ticketsToExport.map(t => [
      t.date,
      t.category || 'Divers',
      t.supplier,
      t.ht + ' ‚Ç¨',
      (t.tvaRate + ' %'),
      t.tva + ' ‚Ç¨',
      t.ttc + ' ‚Ç¨'
    ]);

    const totalHT = ticketsToExport.reduce((s, t) => s + parseFloat(t.ht), 0).toFixed(2);
    const totalTVA = ticketsToExport.reduce((s, t) => s + parseFloat(t.tva), 0).toFixed(2);
    const totalTTC = ticketsToExport.reduce((s, t) => s + parseFloat(t.ttc), 0).toFixed(2);

    tableData.push(['', '', 'TOTAUX', totalHT + ' ‚Ç¨', '', totalTVA + ' ‚Ç¨', totalTTC + ' ‚Ç¨']);

    doc.autoTable({
      startY: 35,
      head: [['Date', 'Cat√©gorie', 'Fournisseur', 'HT', 'Taux TVA', 'TVA', 'TTC']],
      body: tableData,
      theme: 'striped',
      styles: { fontSize: 8 },
      headStyles: { fillColor: [52, 152, 219] },
      footStyles: { fillColor: [46, 204, 113], fontStyle: 'bold' }
    });

    let filename = `tickets_${new Date().toISOString().split('T')[0]}`;
    if (currentMonthFilter !== 'all') filename += `_${currentMonthFilter}`;
    if (currentCategoryFilter !== 'all') filename += `_${currentCategoryFilter}`;
    doc.save(filename + '.pdf');
    
    showStatus('‚úÖ PDF t√©l√©charg√© !', 'success');
  });

  // ===================== Google Drive sync (appDataFolder) =====================
  // S√©curit√© : on N'UTILISE PAS le client_secret c√¥t√© navigateur.
  // On utilise Google Identity Services (token implicite) + REST Drive v3.

  // Petit helper fetch avec token
  async function gFetch(url, options = {}) {
    if (!accessToken) throw new Error('Non connect√© √† Google');
    const headers = Object.assign({}, options.headers || {}, {
      'Authorization': `Bearer ${accessToken}`
    });
    const res = await fetch(url, { ...options, headers });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status} ‚Äî ${text}`);
    }
    return res;
  }

  // Trouve ou cr√©e le fichier appDataFolder/tickets.json
  async function ensureAppDataFile() {
    // 1) recherche
    const q = encodeURIComponent("name='tickets.json' and 'appDataFolder' in parents and trashed=false");
    const listUrl = `https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder&fields=files(id,name)`;
    const listRes = await gFetch(listUrl);
    const list = await listRes.json();
    if (list.files && list.files.length > 0) {
      appDataFileId = list.files[0].id;
      return appDataFileId;
    }
    // 2) cr√©ation multipart (m√©tadonn√©es + contenu vide [])
    const meta = { name: 'tickets.json', parents: ['appDataFolder'] };
    const boundary = '-------314159265358979323846';
    const delimiter = `\r\n--${boundary}\r\n`;
    const closeDelim = `\r\n--${boundary}--`;
    const body = 
      delimiter +
      'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
      JSON.stringify(meta) +
      delimiter +
      'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
      JSON.stringify([]) +
      closeDelim;
    const createRes = await gFetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
      method: 'POST',
      headers: { 'Content-Type': 'multipart/related; boundary=' + boundary },
      body
    });
    const created = await createRes.json();
    appDataFileId = created.id;
    return appDataFileId;
  }

  async function driveSave() {
    try {
      showStatus('‚òÅÔ∏è Sauvegarde sur Drive‚Ä¶', 'loading');
      await ensureAppDataFile();
      const jsonStr = JSON.stringify(tickets);
      await gFetch(`https://www.googleapis.com/upload/drive/v3/files/${appDataFileId}?uploadType=media`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: jsonStr
      });
      showStatus('‚úÖ Donn√©es sauvegard√©es sur Google Drive', 'success');
    } catch (e) {
      showStatus('‚ùå √âchec sauvegarde Drive: ' + e.message, 'error');
    }
  }

  async function driveLoad() {
    try {
      showStatus('‚òÅÔ∏è Chargement depuis Drive‚Ä¶', 'loading');
      await ensureAppDataFile();
      const res = await gFetch(`https://www.googleapis.com/drive/v3/files/${appDataFileId}?alt=media`);
      const remoteTickets = await res.json();
      if (Array.isArray(remoteTickets)) {
        tickets = remoteTickets.map(t => ({
          ...t,
          tvaRate: typeof t.tvaRate === 'undefined' ? 20 : t.tvaRate,
          category: t.category || 'Divers'
        }));
        sortTickets();
        saveTicketsLocal(); // cache local pour offline
        updateFilters();
        renderTickets();
        showStatus('‚úÖ Donn√©es charg√©es depuis Google Drive', 'success');
      } else {
        showStatus('‚ÑπÔ∏è Fichier vide sur Drive (aucun ticket).', 'loading');
      }
    } catch (e) {
      showStatus('‚ùå √âchec chargement Drive: ' + e.message, 'error');
    }
  }

  function enableDriveButtons(enabled) {
    gSave.disabled = !enabled;
    gLoad.disabled = !enabled;
  }

  // Connexion Google ‚Äî utilise GIS pour obtenir un accessToken √† la demande
  window.addEventListener('load', () => {
    // init GIS quand disponible
    function initGIS() {
      if (!window.google || !google.accounts || !google.accounts.oauth2) {
        setTimeout(initGIS, 200);
        return;
      }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: DRIVE_SCOPE,
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            enableDriveButtons(true);
            showStatus('üîê Connect√© √† Google Drive', 'success');
          }
        }
      });
    }
    initGIS();
  });

  gConnect.addEventListener('click', () => {
    if (!tokenClient) { showStatus('‚è≥ Initialisation Google‚Ä¶ r√©essayez', 'loading'); return; }
    tokenClient.requestAccessToken({ prompt: 'consent' });
  });

  gSave.addEventListener('click', driveSave);
  gLoad.addEventListener('click', driveLoad);

  // ---------- Initialisation ----------
  loadTicketsLocal();
  sortTickets();
  updateFilters();
  renderTickets();
  </script>
</body>
</html>
